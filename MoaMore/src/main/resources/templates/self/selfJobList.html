<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{template/layout}">
<head>
<meta charset="UTF-8">
<title>모아모아/셀프구직</title>
<!-- selfJobList.CSS -->
<link href="self/selfJobList.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>
<body>
	<div layout:fragment="content">
	
		<!-- 현재로그인된 유저정보 -->
		<input id="logId" name="id" type="hidden" th:value="${#authentication.principal.username}">
		
		<!-- 현재로그인된 유저가 가진 권한 -->
		<div sec:authorize="hasRole('ROLE_USER')" style="display:none;">
			<input id="ROLE_USER" value="ROLE_USER"> 
		</div>
		<div sec:authorize="hasRole('ROLE_CO')" style="display:none;">
			<input id="ROLE_CO" value="ROLE_CO"> 
		</div>
		
		<!-- nav -->
		<div class="row">
			<div class="col-md-1"></div>
			<div class="col-md-10" style="border-bottom : 1px solid #ddd;">
				<div style="background-color: white;">
					<div style="display:flex; justify-content: center;">
						<select class="selectStyle">
						    <option>활동분야</option>
						    <option>두번째 선택항목</option>
						    <option>세번째 선택항목</option>
						</select>
						<select class="selectStyle">
						    <option>경력조건</option>
						    <option>두번째 선택항목</option>
						    <option>세번째 선택항목</option>
						</select>
						<select class="selectStyle">
						    <option>지역</option>
						    <option>두번째 선택항목</option>
						    <option>세번째 선택항목</option>
						</select>
						<div style="display:flex;">
							<input type="text" class="search" placeholder="이름을 입력하세요">
							<button type="button" class="btn btn-dark btn-sm searchBtn radius">
								<i class="fas fa-search fa-lg"></i>
							</button>
						</div>
						<div class="ms-5">
							<button id="myProfile" type="button" class="btn btn-outline-danger btn-sm radius fs-1">
								My프로필 등록
							</button>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-1"></div>
		</div>
		
		<div class="row" style="margin-top : 30px;">
			<div class="col-md-1"></div>
			<div class="col-md-2" style="margin : 10px;">
				<div style="padding:18px; text-align : center;">
					<h4>Menu</h4>
					<hr>
					<ul class="listStyle">
						<li class="fs-1"><a href="#">받은제안</a></li>
						<li class="fs-1"><a href="#">수락한제안</a></li>
					</ul>
				</div>	
			</div>
			<div id="selfList" class="col-md-7">
				<!-- <div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	              <div class="col-md-3 text-center">
	              	<a href="#">
	              		<img class="img-fluid" src="assets/img/blog/blog-hero.png" alt="">
	              	</a>
	              </div>
	              <div class="col-md-6 text-center text-lg-start">
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	                  <p class="fw-bold mb-0 text-black">Category</p>
	                  <p class="mb-0">November 22, 2021</p>
	                  <span><i id="heartIcon" class="bi bi-suit-heart text-danger fa-2x"></i></span>
	                </div>
	                	<p class="fs-2 my-3">한줄자기소개</p>
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	                	<img class="img-fluid" src="assets/img/blog/profile1.png" alt="">
	                    <p class="mb-0">아이디</p>
	                </div>
	              </div>
	              <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
				      <button type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
				  </div>
	            </div>	 -->	
	            

	             <!-- <div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	              <div class="col-md-3 text-center">
	              	<a href="#">
	              		<img class="img-fluid" src="assets/img/blog/blog-hero.png" alt="">
	              	</a>
	              </div>
	              <div class="col-md-6 text-center text-lg-start">
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	                  <p class="fw-bold mb-0 text-black">Category</p>
	                  <p class="mb-0">November 22, 2021</p>
	                </div>
	                	<p class="fs-2 my-3">한줄자기소개</p>
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	                	<img class="img-fluid" src="assets/img/blog/profile1.png" alt="">
	                    <p class="mb-0">아이디</p>
	                </div>
	              </div>
	              <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
				      <button type="button" class="btn btn-outline-danger btn-sm listBtn">관심</button>
				      <button type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
				  </div>
	            </div> -->
	            
			</div>
			<div class="col-md-1"></div>
		</div>
		
<script>


// 권한에 따른 셀프 구직 목록 리스트
$(document).ready(function() {
	
	let auth = ''; // 권한
	let id = $('#logId').val();
	console.log('id : ' + id);
	if($('#ROLE_USER').val()){ // 유저일때
		console.log('유저입니다 - ROLE_MEM 일때 수정해야할 부분 -');
		auth = 'user';
		
	}else if($('#ROLE_CO').val()){ // 기업일때
		console.log('기업입니다.');
		auth = 'co';
		
	}else{ // 관리자일때
		console.log('관리자입니다.');
		auth = 'admin';
	}
	selfJobList(auth, id); // 셀프 구직 목록 리스트
});


// 관심버튼을 눌렀을때
function interest(interestBtn){
	
	let jobSearchNo = interestBtn.dataset.id; // data - 속성 이용해서 값가져옴
	
	if($('#ROLE_USER').val()){ // 유저일때
		console.log('유저입니다 - ROLE_MEM 일때 수정해야할 부분 -');
		Swal.fire({
			  icon: 'error',
			  title: '기업만 관심등록이 가능합니다.'
		});
		
		return;
		
	}else if($('#ROLE_ADMIN').val()){ // 관리자일때
		console.log('관리자입니다.');

		Swal.fire({
			  icon: 'error',
			  title: '기업만 관심등록이 가능합니다.'
		});
		
		return;
		
	}else{ // 기업일때
	
		let id = $('#logId').val(); // 로그인한 아이디
		let i = $(interestBtn).parent().parent(); // 버튼 누른곳의 부모의 부모 태그
		
		let heartIcon = $(i).find('.heartIcon'); // 부모태그에서 클래스찾기
		
		// 관심 등록 여부
		if(heartIcon.hasClass("bi-suit-heart")){ // 관심이 등록이 안된 상태라면 관심등록
			
			heartIcon.removeClass("bi-suit-heart");
			heartIcon.addClass("bi-suit-heart-fill");
			
			$(interestBtn).removeClass('btn-outline-danger');
			$(interestBtn).addClass('btn-danger');
			$(interestBtn).text('관심해제');
			interestAdd(jobSearchNo); // 관심등록 ajax호출
			//selfJobList('co', id); // 리스트 화면 출력함수
			
		}else{ // 관심등록이 된상태라면 관심해제
			heartIcon.removeClass("bi-suit-heart-fill");
			heartIcon.addClass("bi-suit-heart");
			
			$(interestBtn).removeClass('btn-danger');
			$(interestBtn).addClass('btn-outline-danger');
			$(interestBtn).text('관심');
			
			interestDelete(jobSearchNo); // 관심등록 해제 ajax호출
			
		}
	}
	
}

// 관심등록 ajax호출
function interestAdd(jobSearchNo){
	
	let id = $('#logId').val();
	
	$.ajax({
		  url: 'selfJobInterestAdd',
		  type: 'post',
		  data: {jobSearchNo : jobSearchNo, id : id},
		  success: function (result) {
			//console.log(result);

			Swal.fire({
				icon: 'success',
				title: '관심목록에 추가되었습니다.'
			})

		  },
		  error: function (reject) {	   
	   	  	console.log(reject);
		  }
		});	
}
 
 
function interestDelete(jobSearchNo){
	let id = $('#logId').val();
	
	$.ajax({
		  url: 'selfJobInterestDelete',
		  type: 'post',
		  data: {jobSearchNo : jobSearchNo, id : id},
		  success: function (result) {
			//console.log(result);

			Swal.fire({
			 	icon: 'success',
				title: '관심목록에 삭제되었습니다.'
			})

		  },
		  error: function (reject) {	   
	   	  	console.log(reject);
		  }
		});	
	
}

 
// 셀프구직 리스트 호출하는 ajax
function selfJobList(auth, id){
	
	$.ajax({
	  url: 'selfJobList',
	  type: 'post',
	  data: {auth : auth, id : id},
	  success: function (result) {
		  
		let selfJobList = result.selfJobList;
		let selfJobInterest = result.selfJobInterest;		

		selfList.innerHTML = ''; // 초기화
		
		for(let j = 0; j < selfJobInterest.length ; j++){
			for(let i = 0; i < selfJobList.length; i++){
				if(selfJobInterest[j].jobSearchNo == selfJobList[i].jobSearchNo){
				 	 selfJobList[i].interest = 'Y';	// 관심글에만 'Y'
				}
			}
		}
		
		let selfJobListHtml = '';
		// 화면 리스트 출력
		for(let i = 0; i < selfJobList.length; i++){
			selfJobListHtml += selfJobListPrint(selfJobList[i]);
		}
		
		selfList.innerHTML = selfJobListHtml;
		
	  },
	  error: function (reject) {	   
   	  	console.log(reject);
	  }
	});	
}


function selfJobListPrint(result={}){
	
	let html = '';
	
	if(result.interest == 'Y'){ // 관심글이라면 
		html = `<div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	        <div class="col-md-3 text-center">
	      	<a href="#">
	      		<img class="img-fluid imgSize" src="/moamoreImg/`+result.myimg+`" onerror=this.src="/moamoreImg/profile.JPG" alt="이미지폴더에없음">
	      	</a>
	      </div>
	      <div class="col-md-6 text-center text-lg-start">
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	          <p class="fw-bold mb-0 text-black">`+result.dutyFld+`</p>
	          <p class="mb-0">`+result.hopeWksite+`</p>
	          <p class="mb-0">`+result.regDt+`</p>
	          <span><i data-id="`+result.jobSearchNo+`" class="bi bi-suit-heart-fill text-danger fa-2x heartIcon"></i></span>
	        </div>
	        	<p class="fs-2 my-3">`+result.ttl+`</p>
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	        	<img class="img-fluid" style="display:none;" src="assets/img/blog/profile1.png" alt="">
	            <p class="mb-0">작성자 : `+result.id+`</p>
	            
	        </div>
	      </div>
	      <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
		      <button  data-id="`+result.jobSearchNo+`" onclick="interest(this)" type="button" class="btn btn-danger btn-sm listBtn">관심해제</button>
		      <button  data-id="`+result.jobSearchNo+`" type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
		      <p class="mb-0">`+result.pubcRange+`</p>
		      <p class="mb-0" style="color : blue;">받은관심수: `+result.interest+`<span>, 받은제안수: `+result.prop+`</span></p>
		  </div>
	    </div>`;
	}else{
		html = `<div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	        <div class="col-md-3 text-center">
	      	<a href="#">
	      		<img class="img-fluid imgSize" src="/moamoreImg/`+result.myimg+`" onerror=this.src="/moamoreImg/profile.JPG" alt="이미지폴더에없음">
	      	</a>
	      </div>
	      <div class="col-md-6 text-center text-lg-start">
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	          <p class="fw-bold mb-0 text-black">`+result.dutyFld+`</p>
	          <p class="mb-0">`+result.hopeWksite+`</p>
	          <p class="mb-0">`+result.regDt+`</p>
	          <span><i data-id="`+result.jobSearchNo+`" class="bi bi-suit-heart text-danger fa-2x heartIcon"></i></span>
	        </div>
	        	<p class="fs-2 my-3">`+result.ttl+`</p>
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	        	<img class="img-fluid" src="assets/img/blog/profile1.png" style="display:none;" alt=""> 
	            <p class="mb-0">작성자 : `+result.id+`</p>
	        </div>
	      </div>
	      <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
	   
	      	  <button  data-id="`+result.jobSearchNo+`" onclick="interest(this)" type="button" class="btn btn-outline-danger btn-sm listBtn">관심</button>
		      <button  data-id="`+result.jobSearchNo+`" type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
		      <p class="mb-0">`+result.pubcRange+`</p>
		      <p class="mb-0" style="color : blue;">받은관심수: `+result.interest+`<span>, 받은제안수: `+result.prop+`</span></p>
		  </div>
	    </div>`;
	}
	
	return html;
			    
}


// my프로필 등록 버튼 클릭시 이력가 있는지 체크하는 함수
$('#myProfile').on('click', function(){
	
	let id = logId.value;
	//console.log(id);
	
	$.ajax({
	  url: 'selfJobCheck',
	  type: 'post',
	  data: {id : id},
	  success: function (result) {
		if(result == 0){
			Swal.fire({
				  icon: 'error',
				  title: '작성된 이력서가 없습니다. \n먼저 작성해주세요.'
			});
		}else{
			location.href="/selfJobProfile";
		}
	  },
	  error: function (reject) {	   
   	  	console.log(reject);
	  }
	});	
});
		


		
</script>
	</div>
</body>
</html>