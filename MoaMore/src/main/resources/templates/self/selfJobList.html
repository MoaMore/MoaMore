<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{template/layout}">
<head>
<meta charset="UTF-8">
<title>모아모아/셀프구직조회</title>
<!-- selfJobList.CSS -->
<link href="self/selfJobList.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
</head>
<body>
	<div layout:fragment="content">
	
		<!-- 현재로그인된 유저정보 -->
		<input id="logId" name="id" type="hidden" th:value="${#authentication.principal.username}">
		
		<!-- 현재로그인된 유저가 가진 권한 -->
		<div sec:authorize="hasRole('ROLE_USER')" style="display:none;">
			<input id="ROLE_USER" value="ROLE_USER"> 
		</div>
		<div sec:authorize="hasRole('ROLE_CO')" style="display:none;">
			<input id="ROLE_CO" value="ROLE_CO"> 
		</div>
		
		<!-- nav -->
		<div class="row">
			<div class="col-md-1"></div>
			<div class="col-md-10" style="border-bottom : 1px solid #ddd;">
				<div style="background-color: white;">
					<div style="display:flex; justify-content: center;">
					
						<select id="job" class="selectStyle">
							<option value="" selected>직무선택</option>
							<option th:each="job : ${commList.N}" th:text="${job.desct}" th:attr="value=${job.prov}">직무</option>
					  	</select>
						<select id="carr" class="selectStyle">
							<option value="" selected>경력선택</option>
							<option th:each="carr : ${commList.Y}" th:text="${carr.desct}" th:attr="value=${carr.prov}">경력</option>
					  	</select>
						<select id="city" class="selectStyle">
							<option value="" selected>지역선택</option>
							<option th:each="city : ${commList.X}" th:text="${city.desct}" th:attr="value=${city.prov}">도시</option>
					  	</select>
					  	
						<div style="display:flex;">
							<input type="text" class="search" placeholder="이름을 입력하세요">
							<button type="button" class="btn btn-dark btn-sm searchBtn radius">
								<i class="fas fa-search fa-lg"></i>
							</button>
						</div>
						<div class="ms-5">
							<button id="myProfile" type="button" class="btn btn-outline-danger btn-sm radius fs-1">
								셀프구직 등록
							</button>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-1"></div>
		</div>
		
		<div class="row" style="margin-top : 30px;">
			<div class="col-md-1"></div>
			<div class="col-md-2" style="margin : 10px;">
				<div style="padding:18px; text-align : center;">
					<h4>Menu</h4>
					<hr>
					<ul class="listStyle">
						<li class="fs-1"><a href="#">받은제안</a></li>
						<li class="fs-1"><a href="#">수락한제안</a></li>
					</ul>
				</div>	
			</div>

			<div id="selfList" class="col-md-7">
				<!-- <div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	              <div class="col-md-3 text-center">
	              	<a href="#">
	              		<img class="img-fluid" src="assets/img/blog/blog-hero.png" alt="">
	              	</a>
	              </div>
	              <div class="col-md-6 text-center text-lg-start">
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	                  <p class="fw-bold mb-0 text-black">Category</p>
	                  <p class="mb-0">November 22, 2021</p>
	                  <span><i id="heartIcon" class="bi bi-suit-heart text-danger fa-2x"></i></span>
	                </div>
	                	<p class="fs-2 my-3">한줄자기소개</p>
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	                	<img class="img-fluid" src="assets/img/blog/profile1.png" alt="">
	                    <p class="mb-0">아이디</p>
	                </div>
	              </div>
	              <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
				      <button type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
				  </div>
	            </div>	 -->	
	            

	             <!-- <div class="row align-items-center border-bottom p-4 mb-3 hoverRow">
	              <div class="col-md-3 text-center">
	              	<a href="#">
	              		<img class="img-fluid" src="assets/img/blog/blog-hero.png" alt="">
	              	</a>
	              </div>
	              <div class="col-md-6 text-center text-lg-start">
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	                  <p class="fw-bold mb-0 text-black">Category</p>
	                  <p class="mb-0">November 22, 2021</p>
	                </div>
	                	<p class="fs-2 my-3">한줄자기소개</p>
	                <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	                	<img class="img-fluid" src="assets/img/blog/profile1.png" alt="">
	                    <p class="mb-0">아이디</p>
	                </div>
	              </div>
	              <div class="col-md-3" style="display: flex; align-items: center; flex-direction : column;" >
				      <button type="button" class="btn btn-outline-danger btn-sm listBtn">관심</button>
				      <button type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
				  </div>
	            </div> -->
	            
			</div>
			<div class="col-md-1"></div>
		</div>
		
<script>

let job = ''; // 검색조건 : 직무
let carr = ''; // 검색조건 : 경력
let city = ''; // 검색조건 : 도시
let auth = ''; // 현재 접속한 사람의 권한
let id = '';

// 권한에 따른 셀프 구직 목록 리스트
$(document).ready(function() {
	
	id = $('#logId').val(); // 로그인한 id
	job = $('#job').val();  // 직무 선택
	carr = $('#carr').val(); // 경력 선택
	city = $('#city').val(); // 지역 선택
	
	
	if($('#ROLE_USER').val()){ // 유저일때
		console.log('유저입니다 - ROLE_MEM 일때 수정해야할 부분 -');
		auth = 'user';
		
	}else if($('#ROLE_CO').val()){ // 기업일때
		console.log('기업입니다.');
		auth = 'co';
		
	}else{ // 관리자일때
		console.log('관리자입니다.');
		auth = 'admin';
	}
	
	selfJobList(auth, id, job, carr, city); // 셀프 구직 목록 리스트
});

// 직무 조건 변경시 검색리스트
$('#job').on('change', function(){
	job = $('#job').val();
	selfJobList(auth, id, job, carr, city); // 셀프 구직 목록 리스트
});

//경력 조건 변경시 검색리스트
$('#carr').on('change', function(){
	carr = $('#carr').val();
	selfJobList(auth, id, job, carr, city); // 셀프 구직 목록 리스트
});

//지역 조건 변경시 검색리스트
$('#city').on('change', function(){
	city = $('#city').val();
	selfJobList(auth, id, job, carr, city); // 셀프 구직 목록 리스트
});


// 관심버튼을 눌렀을때
function interest(interestBtn){
	event.stopPropagation(); // 이벤트 전파 막음
	let jobSearchNo = interestBtn.dataset.id; // data - 속성 이용해서 값가져옴
	
	if($('#ROLE_USER').val()){ // 유저일때
		console.log('유저입니다 - ROLE_MEM 일때 수정해야할 부분 -');
		Swal.fire({
			  icon: 'error',
			  title: '기업만 관심등록이 가능합니다.'
		});
		
		return;
		
	}else if($('#ROLE_ADMIN').val()){ // 관리자일때
		console.log('관리자입니다.');

		Swal.fire({
			  icon: 'error',
			  title: '기업만 관심등록이 가능합니다.'
		});
		
		return;
		
	}else{ // 기업일때
	
		let i = $(interestBtn).parent().parent(); // 버튼 누른곳의 조상 태그	
		let heartIcon = $(i).find('.heartIcon'); // 부모태그에서 클래스찾기 , 하트 아이콘
		let interestNum = $(i).find('.interestNum').text(); // 제안수
		
		// 관심 등록 여부
		if(heartIcon.hasClass("bi-suit-heart")){ // 관심이 등록이 안된 상태라면 관심등록
			
			heartIcon.removeClass("bi-suit-heart"); // 빈하트 클래스 지우고
			heartIcon.addClass("bi-suit-heart-fill"); // 꽉찬 하트 클래스 추가
			
			$(interestBtn).removeClass('btn-outline-danger'); // 버튼 부분
			$(interestBtn).addClass('btn-danger');
			$(interestBtn).text('관심해제');
			
			interestNum = parseInt(interestNum) + 1; // 제안수
			$(i).find('.interestNum').text(interestNum);

			interestAdd(jobSearchNo); // 관심등록 ajax호출
			
		}else{ // 관심등록이 된상태라면 관심해제
			
			heartIcon.removeClass("bi-suit-heart-fill");
			heartIcon.addClass("bi-suit-heart");
			
			$(interestBtn).removeClass('btn-danger');
			$(interestBtn).addClass('btn-outline-danger');
			$(interestBtn).text('관심');
			
			interestNum = parseInt(interestNum) - 1;
			$(i).find('.interestNum').text(interestNum);
			
			interestDelete(jobSearchNo,auth); // 관심등록 해제 ajax호출
			
		}
	}
	
}

// 관심등록 ajax호출
function interestAdd(jobSearchNo){

	$.ajax({
		  url: 'selfJobInterestAdd',
		  type: 'post',
		  data: {jobSearchNo : jobSearchNo, id : id},
		  success: function (result) {

			Swal.fire({
				icon: 'success',
				title: '관심목록에 추가되었습니다.'
		   });
		   //selfJobList(auth, id, job, carr, city); // 리스트 화면 출력함수

		  },
		  error: function (reject) {	   
	   	  	console.log(reject);
		  }
		});	
}
 
// 관심등록 해제
function interestDelete(jobSearchNo){

	$.ajax({
		  url: 'selfJobInterestDelete',
		  type: 'post',
		  data: {jobSearchNo : jobSearchNo, id : id},
		  success: function (result) {
			//console.log(result);

			Swal.fire({
			 	icon: 'success',
				title: '관심목록에 삭제되었습니다.'
			})
			//selfJobList(auth, id, job, carr, city); // 리스트 화면 출력함수
		  },
		  error: function (reject) {	   
	   	  	console.log(reject);
		  }
		});	
	
}

 
// 셀프구직 리스트 호출하는 ajax
function selfJobList(auth, id, job, carr, city){
	
	$.ajax({
	  url: 'selfJobList',
	  type: 'post',
	  data: {auth : auth, id : id, dutyFld : job, career : carr, hopeWksite : city},
	  success: function (result) {
		  
		let selfJobList = result.selfJobList; // 셀프구직 목록 리스트
		let selfJobInterest = result.selfJobInterest; // 접속한 ID의 셀프구직 관심 리스트

		selfList.innerHTML = ''; // 초기화
		
		if(selfJobList.length == 0){
			selfList.innerHTML = `<div class="fs-2 mt-5" style="text-align : center;">검색조건에 만족하는게 없습니다.</div>`;
			return;
		}else{
		
			for(let j = 0; j < selfJobInterest.length ; j++){
				for(let i = 0; i < selfJobList.length; i++){
					if(selfJobInterest[j].jobSearchNo == selfJobList[i].jobSearchNo){
					 	 selfJobList[i].interestYn = 'Y';	// 관심글에만 'Y'
					}
				}
			}
			
			let selfJobListHtml = '';
			// 화면 리스트 출력
			for(let i = 0; i < selfJobList.length; i++){
				selfJobListHtml += selfJobListPrint(selfJobList[i]);
			}
			
			selfList.innerHTML = selfJobListHtml;
	 	 }
	  },
	  error: function (reject) {	   
   	  	console.log(reject);
	  }
	});	
}


function selfJobListPrint(result={}){
	
	let html = '';
	//console.log(result.interestYn == 'Y');
	// interestYn : 해당 게시글에 관심 등록이 되어있는지 여부
	if(result.interestYn == 'Y'){ // 관심글이라면 
		html = `<div class="row align-items-center border-bottom p-4 mb-3 hoverRow" style="cursor:pointer;" onclick="location.href='/selfJobDetail?jobSearchNo=`+result.jobSearchNo+`'">
	        <div class="col-md-3 text-center">
	      	<a href="#">
	      		<img class="img-fluid imgSize" src="/moamoreImg/`+result.myimg+`" onerror=this.src="self/profile.JPG" alt="이미지폴더에없음">
	      		<p class="mb-0">`+result.pubcRange+`</p>
	      	</a>
	      </div>
	      <div class="col-md-5 text-center text-lg-start">
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	          <p class="fw-bold mb-0 text-black">`+result.dutyFld+`</p>
	          <p class="mb-0">`+result.hopeWksite+`</p>
	          <p class="mb-0">`+result.regDt+`</p>
	          <i data-id="`+result.jobSearchNo+`" class="bi bi-suit-heart-fill text-danger fa-lg heartIcon"><span class="interestNum" style="color:#5B7075; font-style: normal;">`+result.interest+`</span></i>
	        </div>
	        	<p class="fs-2 my-3">`+result.ttl+`</p>
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	        	<img class="img-fluid" style="display:none;" src="assets/img/blog/profile1.png" alt="">
	            <p class="mb-0">작성자 : `+result.id+`</p>
	            
	        </div>
	      </div>
	      <div class="col-md-4" style="display: flex; align-items: center; flex-direction : column;" >
	      	
		      <button  data-id="`+result.jobSearchNo+`" onclick="interest(this)" type="button" class="btn btn-danger btn-sm listBtn">관심해제</button>
		      <button  data-id="`+result.jobSearchNo+`" type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
		  </div>
	    </div>`;
	}else{
		html = `<div class="row align-items-center border-bottom p-4 mb-3 hoverRow" style="cursor:pointer;" onclick="location.href='/selfJobDetail?jobSearchNo=`+result.jobSearchNo+`'">
	        <div class="col-md-3 text-center">
	      	<a href="#">
	      		<img class="img-fluid imgSize" src="/moamoreImg/`+result.myimg+`" onerror=this.src="self/profile.JPG" alt="이미지폴더에없음">
	      		<p class="mb-0">`+result.pubcRange+`</p>
	      	</a>
	      </div>
	      <div class="col-md-5 text-center text-lg-start">
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-3">
	          <p class="fw-bold mb-0 text-black">`+result.dutyFld+`</p>
	          <p class="mb-0">`+result.hopeWksite+`</p>
	          <p class="mb-0">`+result.regDt+`</p>
	          <i data-id="`+result.jobSearchNo+`" class="bi bi-suit-heart text-danger fa-lg heartIcon"><span class="interestNum" style="color:#5B7075; font-style: normal;">`+result.interest+`</span></i>
	        </div>
	        	<p class="fs-2 my-3">`+result.ttl+`</p>
	        <div class="d-flex align-items-center justify-content-center justify-content-lg-start gap-2">
	        	<img class="img-fluid" src="assets/img/blog/profile1.png" style="display:none;" alt=""> 
	            <p class="mb-0">작성자 : `+result.id+`</p>
	        </div>
	      </div>
	      <div class="col-md-4" style="display: flex; align-items: center; flex-direction : column;" >
	      	  
	      	  <button  data-id="`+result.jobSearchNo+`" onclick="interest(this)" type="button" class="btn btn-outline-danger btn-sm listBtn">관심</button>
		      <button  data-id="`+result.jobSearchNo+`" type="button" class="btn btn-outline-info btn-sm listBtn">제안</button>
		  </div>
	    </div>`;
	}
	
	return html;
			    
}


// 셀프구직 등록 버튼 클릭시 이력가 있는지 체크하는 함수
$('#myProfile').on('click', function(){
	
	if($('#ROLE_USER').val()){ // 유저일때
		$.ajax({
			  url: 'selfJobCheck',
			  type: 'post',
			  data: {id : id},
			  success: function (result) {
				if(result == 0){
					Swal.fire({
						  icon: 'error',
						  title: '작성된 이력서가 없습니다. \n이력서를 먼저 작성해주세요.'
					});
				}else{
					location.href="/selfJobProfile";
				}
			  },
			  error: function (reject) {	   
		   	  	console.log(reject);
			  }
			});	
	}else if($('#ROLE_CO').val()){ // 기업일때
		
		Swal.fire({
			  icon: 'error',
			  title: '기업은 셀프구직을 \n작성할 수 없습니다.'
		});
		
	}else{ // 관리자일때
		Swal.fire({
			  icon: 'error',
			  title: '관리자는 셀프구직을 \n작성할 수 없습니다.'
		});
	}
});
			
</script>
	</div>
</body>
</html>